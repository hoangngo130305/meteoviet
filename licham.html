<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thời tiết - Meteo Việt</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="licham.css" />
  </head>
  <body>
    <div class="app">
      <div class="top-bar fixed-bar">
        <div class="menu-icon">☰</div>
        <div class="title">LỊch ÂM</div>
      </div>

      <div class="calendar-box">
        <div class="calendar-header">
          <i class="fa-solid fa-chevron-left" onclick="changeMonth(-1)"></i>
          <span id="calendar-month"></span>
          <i class="fa-solid fa-chevron-right" onclick="changeMonth(1)"></i>
        </div>
        <div class="calendar-weekdays">
          <div>T2</div><div>T3</div><div>T4</div><div>T5</div><div>T6</div><div>T7</div><div>CN</div>
        </div>
        <div class="calendar-grid" id="calendar-grid"></div>
        <div class="calendar-arrow-down" onclick="toggleCalendarView()">
          <i class="fa-solid fa-chevron-down" id="toggle-arrow"></i>
        </div>
      </div>

      <div class="calendar-info">
        <div class="calendar-column">
          <div class="label-small">Dương lịch</div>
          <div class="label-gray">Ngày</div>
          <div class="day" id="solar-day">--</div>
          <div class="label" id="solar-label">--</div>
        </div>
        <div class="divider-vertical"></div>
        <div class="calendar-column">
          <div class="label-small">Âm lịch</div>
          <div class="label-gray">Ngày</div>
          <div class="day" id="lunar-day">--</div>
          <div class="label" id="lunar-label">--</div>
        </div>
      </div>

      <div class="section">
        <div class="uv-date-box">
          <p id="selected-date">--</p>
        </div>
        <div class="weather-info-container">
          <div class="info-row top-row">
            <div class="info-box">
              <div class="info-header"><span>Độ ẩm</span><div class="icon-circle"><i class="fa-solid fa-droplet"></i></div></div>
              <div class="info-value" id="humidity">--%</div>
            </div>
            <div class="info-box">
              <div class="info-header"><span>Lượng mưa</span><div class="icon-circle"><i class="fa-solid fa-cloud-rain"></i></div></div>
              <div class="info-value" id="rain">-- mm</div>
            </div>
          </div>

          <div class="info-row wind-section">
            <div class="wind-details">
              <div class="section-title">Gó</div>
              <div class="wind-info">
                <div class="wind-item"><span>Gó</span><span class="wind-value" id="wind">-- km/h</span></div>
                <hr />
                <div class="wind-item"><span>Gó giật</span><span class="wind-value" id="gust">-- km/h</span></div>
                <hr />
                <div class="wind-item"><span>Hướng gó</span><span class="wind-value" id="wind-dir">--</span></div>
              </div>
            </div>
            <div class="wind-speed">
              <div class="wind-icon"><i class="fa-solid fa-wind"></i></div>
              <div class="compass">
                <div class="direction n">N</div><div class="direction s">S</div><div class="direction w">W</div><div class="direction e">E</div>
                <div class="center-speed" id="center-speed">--<br /><span>km/h</span></div>
                <div class="arrow" id="arrow-dir" style="transform: rotate(0deg)"></div>
              </div>
            </div>
          </div>

          <div class="info-row top-row">
            <div class="info-box">
              <div class="info-header"><span>Mây che phủ</span><div class="icon-circle"><i class="fa-solid fa-cloud"></i></div></div>
              <div class="info-value" id="cloud">--%</div>
            </div>
            <div class="info-box">
              <div class="info-header"><span>Tầm nhìn</span><div class="icon-circle"><i class="fa-solid fa-eye"></i></div></div>
              <div class="info-value" id="vis">-- km</div>
            </div>
          </div>
        </div>
      </div>

      <div class="bottom-nav">
        <div class="nav-item"><i class="fa-solid fa-calendar-days"></i><a href="index.html"><div>Hôm nay</div></a></div>
        <div class="nav-item"><i class="fa-solid fa-clock"></i><a href="homnay2.html"><div>Theo giờ</div></a></div>
        <div class="nav-item"><i class="fa-solid fa-calendar-day"></i><a href="hangngay.html"><div>Hằng ngày</div></a></div>
        <div class="nav-item"><i class="fa-solid fa-chart-simple"></i><a href="thuyvan.html"><div>Thủy văn</div></a></div>
        <div class="nav-item"><i class="fa-solid fa-calendar-minus"></i><a href="licham.html"><div class="active">LỊch âm</div></a></div>
      </div>
    </div>

    <script>
      const API = "http://127.0.0.1:8000/api";
      const wardId = localStorage.getItem("selectedWardId");
      let currentDate = new Date();
      const calendarGrid = document.getElementById("calendar-grid");
      const calendarMonthText = document.getElementById("calendar-month");

      function renderCalendar(date = new Date()) {
        calendarGrid.innerHTML = "";
        const year = date.getFullYear();
        const month = date.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const firstWeekday = firstDay.getDay() || 7;
        const totalDays = lastDay.getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();
        const days = [];

        for (let i = firstWeekday - 1; i > 0; i--) days.push({ solar: daysInPrevMonth - i + 1, lunar: getFakeLunar(daysInPrevMonth - i + 1), other: true });
        for (let d = 1; d <= totalDays; d++) days.push({ solar: d, lunar: getFakeLunar(d), other: false });
        for (let d = 1; d <= 42 - days.length; d++) days.push({ solar: d, lunar: getFakeLunar(d), other: true });

        days.forEach((day) => {
          const div = document.createElement("div");
          div.className = "calendar-day" + (day.other ? " other-month" : "");
          div.innerHTML = `<span class="solar">${day.solar}</span><span class="lunar">${day.lunar}</span>`;

          div.onclick = () => {
            document.querySelectorAll(".calendar-day").forEach((d) => d.classList.remove("selected"));
            div.classList.add("selected");

            if (!day.other) {
              const mm = String(month + 1).padStart(2, "0");
              const dd = String(day.solar).padStart(2, "0");
              const dateStr = `${year}-${mm}-${dd}`;

              document.getElementById("solar-day").textContent = dd;
              document.getElementById("solar-label").textContent = `Tháng ${month + 1}, ${year}`;
              document.getElementById("lunar-day").textContent = day.lunar;
              document.getElementById("lunar-label").textContent = `Tháng ${month + 1}, ất tỵ`;

              fetchWeatherForDate(dateStr);
            }
          };

          calendarGrid.appendChild(div);
        });

        calendarMonthText.textContent = `Tháng ${month + 1}, ${year}`;
        fetchWeatherForDate(new Date().toISOString().split("T")[0]);
      }

      function fetchWeatherForDate(dateStr) {
        if (!wardId) return;
        fetch(`${API}/weather/?ward_id=${wardId}&date=${dateStr}`)
          .then((res) => res.json())
          .then((data) => {
            const hour12 = data.forecast?.forecastday?.[0]?.hour?.[12] || {};
            const dayData = data.forecast?.forecastday?.[0]?.day || {};

            document.getElementById("selected-date").textContent = new Date(dateStr).toLocaleDateString("vi-VN", { weekday: "long", day: "numeric", month: "long" });
            document.getElementById("humidity").textContent = dayData.avghumidity + "%";
            document.getElementById("rain").textContent = dayData.totalprecip_mm + " mm";
            document.getElementById("wind").textContent = dayData.maxwind_kph + " km/h";
            document.getElementById("gust").textContent = (hour12.gust_kph ?? "--") + " km/h";
            document.getElementById("wind-dir").textContent = hour12.wind_dir || "--";
            document.getElementById("center-speed").innerHTML = `${dayData.maxwind_kph}<br><span>km/h</span>`;
            document.getElementById("arrow-dir").style.transform = `rotate(${hour12.wind_degree || 0}deg)`;
            document.getElementById("cloud").textContent = (hour12.cloud ?? "--") + "%";
            document.getElementById("vis").textContent = dayData.avgvis_km + " km";
          })
          .catch((err) => console.error("Lỗi fetch API:", err));
      }

      function getFakeLunar(solar) {
        return solar + 3 > 30 ? (solar + 3 - 30).toString().padStart(2, "0") : (solar + 3).toString().padStart(2, "0");
      }

      function changeMonth(step) {
        currentDate.setMonth(currentDate.getMonth() + step);
        renderCalendar(currentDate);
      }

      function toggleCalendarView() {
        const grid = document.getElementById("calendar-grid");
        const arrow = document.getElementById("toggle-arrow");
        grid.classList.toggle("collapsed");
        arrow.classList.toggle("fa-chevron-down");
        arrow.classList.toggle("fa-chevron-up");
      }

      document.querySelectorAll(".bottom-nav .nav-item").forEach((item) => {
        const href = item.querySelector("a").getAttribute("href").split("/").pop();
        if (window.location.pathname.split("/").pop() === href) item.classList.add("active");
      });

      renderCalendar(currentDate);
    </script>
  </body>
</html>
