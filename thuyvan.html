<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thời tiết - Meteo Việt</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <link rel="stylesheet" href="thuyvan.css" />
  </head>
  <body>
    <div class="app">
      <div class="top-bar fixed-bar">
        <div class="menu-icon">☰</div>
        <div class="title">HỒ CHÍ MINH</div>
        <!-- <button class="btn-licham hidden">Lịch âm</button> -->
      </div>

      <div class="headerr">
        <p class="today">Hôm nay, ngày 23 tháng 4 (dương lịch)</p>
        <p class="today lunar">nhằm ngày 22 tháng 3 (âm lịch)</p>
        <p class="status">Tình trạng hiện tại</p>
      </div>

      <div class="tide-box">
        <!-- Hàng tiêu đề -->
        <div class="tide-header">
          <div class="tide-title">
            <i class="fa-solid fa-arrow-up"></i> Đỉnh triều
          </div>
          <div class="tide-title">
            <i class="fa-solid fa-arrow-down"></i> Chân triều
          </div>
        </div>

        <!-- Hàng dữ liệu -->
        <div class="tide-grid">
          <div class="tide-col">
            <p class="label">Mực nước</p>
            <p class="value red">1,6</p>
            <p class="time">19:00</p>
          </div>
          <div class="tide-col">
            <p class="label">Mực nước</p>
            <p class="value blue">1,34</p>
            <p class="time">08:30</p>
          </div>
          <div class="tide-col">
            <p class="label">Mực nước</p>
            <p class="value black">-1,18</p>
            <p class="time">19:00</p>
          </div>
          <div class="tide-col">
            <p class="label">Mực nước</p>
            <p class="value bold">0,29</p>
            <p class="time">19:00</p>
          </div>
        </div>
      </div>

      <!-- Chart -->
      <div class="chart-box">
        <h5>Dự báo thủy triều</h5>
        <div class="chart-container" style="position: relative">
          <canvas id="tideChart" height="250"></canvas>
        </div>
      </div>

      <!-- Hệ số -->
      <div class="info-box">
        <h5><i class="fa-regular fa-circle-question"></i> Hệ số thủy triều</h5>
        <p class="desc">
          Hệ số thủy triều cho chúng ta biết biên độ của dự báo thủy triều
          (chênh lệch về chiều cao giữa các mức thủy triều cao và thấp liên tiếp
          ở bất kỳ khu vực nào trước đó).
        </p>
        <ul class="legend">
          <li>
            <span class="dot black"></span> Bình thường
            <span class="level">> 1,0m</span>
          </li>
          <li>
            <span class="dot green"></span> Báo động I
            <span class="level">> 1,40m</span>
          </li>
          <li>
            <span class="dot orange"></span> Báo động II
            <span class="level">> 1,50m</span>
          </li>
          <li>
            <span class="dot red"></span> Báo động III
            <span class="level">> 1,60m</span>
          </li>
        </ul>
      </div>

      <!-- Footer -->
      <div class="footer-bar">
        <div class="footer-left">
          <i class="fa-solid fa-map icon"></i>
          <select id="station-select">
            <option value="">Chọn trạm thủy văn</option>
          </select>
        </div>

        <div class="footer-right">
          <i class="fa-solid fa-chevron-down arrow"></i>
          <div class="footer-separator"></div>
          <input type="date" id="date-picker" class="label" />

          <i class="fa-solid fa-chevron-down arrow"></i>
        </div>
      </div>

      <div class="bottom-nav">
        <div class="nav-item">
          <i class="fa-solid fa-calendar-days"></i>
          <a href="index.html"><div>Hôm nay</div></a>
        </div>
        <div class="nav-item">
          <i class="fa-solid fa-clock"></i>
          <a href="homnay2.html"><div>Theo giờ</div></a>
        </div>
        <div class="nav-item">
          <i class="fa-solid fa-calendar-day"></i>
          <a href="hangngay.html"><div>Hằng ngày</div></a>
        </div>
        <div class="nav-item">
          <i class="fa-solid fa-chart-simple"></i>
          <a href="thuyvan.html"><div>Thủy văn</div></a>
        </div>
        <div class="nav-item">
          <i class="fa-solid fa-calendar-minus"></i>
          <a href="licham.html"><div>Lịch âm</div></a>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const API = "http://127.0.0.1:8000/api";
      const ctx = document.getElementById("tideChart").getContext("2d");

      function createGradient(ctx) {
        const gradient = ctx.createLinearGradient(0, 0, 0, 250);
        gradient.addColorStop(0, "#e0f0ff");
        gradient.addColorStop(1, "#2e7cf6");
        return gradient;
      }

      const tideChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Mực nước (m)",
              data: [],
              borderColor: "#2e7cf6",
              backgroundColor: createGradient(ctx),
              fill: true,
              tension: 0.4,
              pointBackgroundColor: "#ff4c4c",
              pointRadius: 5,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              min: 0,
              max: 5,
              title: {
                display: true,
                text: "m",
                font: { weight: "bold" },
              },
              ticks: { stepSize: 1, color: "#444" },
              grid: { display: false },
            },
            x: {
              ticks: { color: "#444" },
              grid: { display: false },
            },
          },
        },
      });

      const stationSelect = document.getElementById("station-select");
      const dateInput = document.getElementById("date-picker");

      // Load danh sách trạm thủy văn
      fetch(`${API}/stations/`)
        .then((res) => res.json())
        .then((data) => {
          data.forEach((station) => {
            const option = document.createElement("option");
            option.value = station.station_id;
            option.textContent = station.station_name;
            stationSelect.appendChild(option);
          });
        })
        .catch((err) => console.error("Lỗi tải danh sách trạm:", err));

      // Load dữ liệu thủy văn khi chọn trạm hoặc ngày
      function loadHydrologyDataByURL(url) {
        fetch(url)
          .then((res) => res.json())
          .then((data) => {
            if (!data || data.length === 0) return;

            // Cập nhật các thẻ mực nước
            const tideCols = document.querySelectorAll(".tide-col");
            for (let i = 0; i < 4 && i < data.length; i++) {
              const d = data[i];
              const time = new Date(d.measurement_time).toLocaleTimeString(
                "vi-VN",
                {
                  hour: "2-digit",
                  minute: "2-digit",
                }
              );
              tideCols[i].querySelector(".value").textContent =
                d.water_level.toFixed(2);
              tideCols[i].querySelector(".time").textContent = time;
            }

            // Cập nhật biểu đồ
            const chartData = data.slice(0, 12).reverse();
            tideChart.data.labels = chartData.map(
              (d) => new Date(d.measurement_time).getHours() + "h"
            );
            tideChart.data.datasets[0].data = chartData.map(
              (d) => d.water_level
            );
            tideChart.update();

            // Hiển thị tên trạm và ngày
            const newest = data[0];
            document.querySelector(".footer-left .label").textContent =
              newest.station.station_name;
            dateInput.value = newest.measurement_time.split("T")[0];
          })
          .catch((err) => console.error("Lỗi khi tải dữ liệu thủy văn:", err));
      }

      // Khi chọn trạm
      stationSelect.addEventListener("change", () => {
        const stationId = stationSelect.value;
        const date = dateInput.value;
        if (stationId) {
          let url = `${API}/hydrology/?station_id=${stationId}`;
          if (date) url += `&date=${date}`;
          loadHydrologyDataByURL(url);
        }
      });

      // Khi chọn ngày
      dateInput.addEventListener("change", () => {
        const stationId = stationSelect.value;
        const date = dateInput.value;
        if (stationId) {
          let url = `${API}/hydrology/?station_id=${stationId}&date=${date}`;
          loadHydrologyDataByURL(url);
        }
      });

      // Khi mở trang lần đầu (mặc định chưa có trạm nào) → có thể thêm station_id mặc định nếu cần
    </script>
  </body>
</html>
